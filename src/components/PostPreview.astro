---
import IconChevronsRight from '~/icons/chevrons-right.svg'
import type { CollectionEntry } from 'astro:content'
import { render } from 'astro:content'
import Tags from '~/components/Tags.astro'
import PostInfo from '~/components/PostInfo.astro'
import type { Collation } from '~/types'
import { TagsGroup, getPostAnchorId, getPostSlug } from '~/utils'
import { localizePath, useTranslations, type Lang } from '~/i18n/config'
import { Image } from 'astro:assets'

interface Props {
  post: CollectionEntry<'posts'>
  lang: Lang
}

const { post, lang } = Astro.props
const t = useTranslations(lang)

const { remarkPluginFrontmatter } = await render(post)
const description = remarkPluginFrontmatter.description || post.data.description
let tags: Collation<'posts'>[] | undefined
if (post.data.tags && post.data.tags.length > 0) {
  const tagsGroup = await TagsGroup.build(undefined, lang)
  tags = tagsGroup.matchMany(post.data.tags)
}
const slug = getPostSlug(post)
const anchorId = getPostAnchorId(post)
const postHref = localizePath(`/posts/${slug}`, lang)
const samePage = Astro.url.pathname === postHref
const articleLink = samePage ? `#${anchorId}` : postHref
---

<article class="w-full py-5 my-1 md:my-4 border-accent/10">
  <h1 class="mb-3 text-2xl text-heading1 font-semibold">
    <a href={articleLink}># {post.data.title}</a>
  </h1>
  <PostInfo post={post} lang={lang} class="mb-3 mt-4" />
  <div class="flex gap-4 mb-4 items-start">
    {
      post.data.coverImage && (
        <Image
          priority
          layout="constrained"
          src={post.data.coverImage.src}
          alt={post.data.coverImage.alt}
          class="w-48 rounded-xl"
        />
      )
    }
    <div>
      {
        description && (
          <p class="pl-0.5 mb-4 text-base/7 text-foreground">{description}</p>
        )
      }
      {
        tags && (
          <div>
            <Tags tags={tags} />
          </div>
        )
      }
    </div>
  </div>

  <div>
    <a class="button flex items-center !pl-3.5" href={articleLink}>
      {samePage ? t('posts.continue') : t('posts.read')}
      <IconChevronsRight class="size-5 ml-2" />
    </a>
  </div>
</article>
